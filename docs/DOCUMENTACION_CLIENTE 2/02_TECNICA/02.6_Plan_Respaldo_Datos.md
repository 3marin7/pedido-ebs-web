# ğŸ›¡ï¸ PLAN DE RESPALDO Y RECUPERACIÃ“N DE DATOS
## Sistema de GestiÃ³n Comercial Distribuciones EBS

**Cliente:** [Nombre del Cliente]  
**Fecha de preparaciÃ³n:** 3 de febrero de 2026  
**Responsable tÃ©cnico:** Edwin MarÃ­n  
**VersiÃ³n:** 1.0  
**Estado:** Aprobado para implementaciÃ³n

---

## ğŸ“‹ TABLA DE CONTENIDOS

1. [Objetivo y Alcance](#objetivo-y-alcance)
2. [PolÃ­tica de Respaldos](#polÃ­tica-de-respaldos)
3. [Estrategia de Respaldo](#estrategia-de-respaldo)
4. [Tipos de Respaldo](#tipos-de-respaldo)
5. [Frecuencia y RetenciÃ³n](#frecuencia-y-retenciÃ³n)
6. [Procedimientos de Respaldo](#procedimientos-de-respaldo)
7. [Procedimientos de RestauraciÃ³n](#procedimientos-de-restauraciÃ³n)
8. [Plan de RecuperaciÃ³n ante Desastres](#plan-de-recuperaciÃ³n-ante-desastres)
9. [Pruebas de RecuperaciÃ³n](#pruebas-de-recuperaciÃ³n)
10. [Monitoreo y Alertas](#monitoreo-y-alertas)
11. [Roles y Responsabilidades](#roles-y-responsabilidades)
12. [Costos y Recursos](#costos-y-recursos)

---

## ğŸ¯ OBJETIVO Y ALCANCE

### Objetivo Principal
Garantizar la **disponibilidad, integridad y recuperabilidad** de todos los datos crÃ­ticos del Sistema EBS, minimizando la pÃ©rdida de informaciÃ³n ante cualquier incidente y asegurando la continuidad del negocio.

### Objetivos EspecÃ­ficos
âœ… **RPO (Recovery Point Objective):** PÃ©rdida mÃ¡xima de datos aceptable = **1 hora**  
âœ… **RTO (Recovery Time Objective):** Tiempo mÃ¡ximo de recuperaciÃ³n = **4 horas**  
âœ… **Disponibilidad del sistema:** 99.5% anual (downtime mÃ¡ximo ~43 horas/aÃ±o)  
âœ… **Integridad de datos:** 100% verificada mediante checksums  
âœ… **RetenciÃ³n histÃ³rica:** MÃ­nimo 90 dÃ­as, crÃ­ticos 1 aÃ±o

### Alcance del Plan

**Incluye:**
- âœ… Base de datos completa (Supabase)
- âœ… Archivos de configuraciÃ³n
- âœ… ImÃ¡genes de productos (Cloudinary)
- âœ… DocumentaciÃ³n del sistema
- âœ… CÃ³digo fuente de la aplicaciÃ³n

**No incluye (fuera de alcance):**
- âŒ Sistemas operativos del servidor (responsabilidad de Supabase)
- âŒ Software de terceros (Cloudinary hace sus propios backups)
- âŒ Estaciones de trabajo locales

---

## ğŸ“œ POLÃTICA DE RESPALDOS

### Principios Fundamentales

#### 1. **Regla 3-2-1**
```
3 copias de los datos:
  â”œâ”€ 1 copia primaria (producciÃ³n)
  â”œâ”€ 1 copia local/nearline (Supabase backups)
  â””â”€ 1 copia remota/offsite (AWS S3 / Google Cloud Storage)

2 tipos de medios diferentes:
  â”œâ”€ Base de datos Supabase
  â””â”€ Almacenamiento objeto (S3/GCS)

1 copia fuera del sitio (off-site):
  â””â”€ RegiÃ³n geogrÃ¡fica diferente
```

#### 2. **Criticidad de Datos**

| Nivel | Tipo de Dato | RPO | RTO | RetenciÃ³n |
|-------|--------------|-----|-----|-----------|
| ğŸ”´ **CRÃTICO** | Facturas, transacciones | 1 hora | 2 horas | 1 aÃ±o |
| ğŸŸ¡ **IMPORTANTE** | Productos, clientes | 4 horas | 4 horas | 90 dÃ­as |
| ğŸŸ¢ **NORMAL** | ConfiguraciÃ³n, logs | 24 horas | 8 horas | 30 dÃ­as |

#### 3. **Responsabilidad Compartida**

| Componente | Responsable | Backup | VerificaciÃ³n |
|------------|-------------|--------|--------------|
| Base de datos Supabase | Supabase (automÃ¡tico) | Continuo | Diario |
| Backup personalizado | Edwin MarÃ­n / EBS | Diario | Semanal |
| ImÃ¡genes Cloudinary | Cloudinary (automÃ¡tico) | Continuo | Mensual |
| CÃ³digo fuente | GitHub | Cada commit | AutomÃ¡tico |
| Backup off-site | EBS | Semanal | Mensual |

---

## ğŸ¯ ESTRATEGIA DE RESPALDO

### Enfoque HÃ­brido: AutomÃ¡tico + Manual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ESTRATEGIA DE RESPALDO MULTINIVEL             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NIVEL 1: SUPABASE AUTOMÃTICO (Infraestructura)
â”œâ”€ Point-in-Time Recovery (PITR): Continuo
â”œâ”€ Snapshots automÃ¡ticos: Cada hora
â”œâ”€ RetenciÃ³n: 7 dÃ­as
â””â”€ RecuperaciÃ³n: < 30 minutos

NIVEL 2: BACKUP PERSONALIZADO (AplicaciÃ³n)
â”œâ”€ Backup completo diario: 2:00 AM
â”œâ”€ Backup incremental: Cada 6 horas
â”œâ”€ RetenciÃ³n: 90 dÃ­as
â””â”€ RecuperaciÃ³n: < 2 horas

NIVEL 3: BACKUP OFF-SITE (Disaster Recovery)
â”œâ”€ Backup semanal completo: Domingos 3:00 AM
â”œâ”€ Almacenamiento: AWS S3 (regiÃ³n diferente)
â”œâ”€ RetenciÃ³n: 1 aÃ±o para datos crÃ­ticos
â””â”€ RecuperaciÃ³n: < 8 horas

NIVEL 4: VERSIONADO DE CÃ“DIGO
â”œâ”€ GitHub: Cada commit
â”œâ”€ Branches: main, develop, feature/*
â”œâ”€ Tags: Versiones estables
â””â”€ RecuperaciÃ³n: InstantÃ¡nea
```

---

## ğŸ“¦ TIPOS DE RESPALDO

### 1. **Backup Completo (Full Backup)**

**DescripciÃ³n:** Copia completa de toda la base de datos y archivos.

**Ventajas:**
- âœ… RecuperaciÃ³n mÃ¡s rÃ¡pida
- âœ… Independiente de otros backups
- âœ… Integridad garantizada

**Desventajas:**
- âŒ Consume mÃ¡s espacio
- âŒ Toma mÃ¡s tiempo

**CuÃ¡ndo se ejecuta:**
- Diario: 2:00 AM (automatizado)
- Semanal: Domingos 3:00 AM (off-site)
- Manual: Antes de cambios crÃ­ticos

**Contenido:**
```sql
-- Tablas incluidas en backup completo
âœ… productos (todos los campos)
âœ… clientes (todos los campos)
âœ… facturas (incluye JSONB de productos)
âœ… abonos (todos los registros)
âœ… movimientos_inventario (historial completo)
âœ… auditoria_productos (logs de cambios)
âœ… pedidos (si existe)
âœ… usuarios (credenciales hasheadas)
```

---

### 2. **Backup Incremental**

**DescripciÃ³n:** Solo registros modificados desde el Ãºltimo backup.

**Ventajas:**
- âœ… RÃ¡pido de ejecutar
- âœ… Ahorra espacio
- âœ… Frecuencia mayor posible

**Desventajas:**
- âŒ RecuperaciÃ³n mÃ¡s lenta
- âŒ Requiere backup completo previo

**CuÃ¡ndo se ejecuta:**
- Cada 6 horas: 8:00 AM, 2:00 PM, 8:00 PM
- AutomÃ¡tico (cron job)

**Query de ejemplo:**
```sql
-- Backup incremental: solo cambios desde Ãºltima backup
SELECT * FROM facturas 
WHERE created_at > (
  SELECT MAX(fecha_backup) 
  FROM control_backups 
  WHERE tipo = 'incremental'
);

SELECT * FROM productos 
WHERE updated_at > [ULTIMO_BACKUP];
```

---

### 3. **Backup Diferencial**

**DescripciÃ³n:** Cambios desde el Ãºltimo backup COMPLETO.

**CuÃ¡ndo se usa:**
- Antes de actualizaciones mayores del sistema
- Antes de migraciones de datos
- Antes de cambios masivos en catÃ¡logo

**Ventajas:**
- âœ… Balance entre completo e incremental
- âœ… RecuperaciÃ³n mÃ¡s rÃ¡pida que incremental

---

### 4. **Snapshot de Base de Datos**

**DescripciÃ³n:** Imagen instantÃ¡nea del estado de la BD (Supabase nativo).

**CaracterÃ­sticas:**
- AutomÃ¡tico por Supabase
- Cada hora
- RetenciÃ³n: 7 dÃ­as
- RecuperaciÃ³n en < 30 minutos

**Uso:**
- RecuperaciÃ³n rÃ¡pida de errores recientes
- Rollback de cambios accidentales
- No requiere restauraciÃ³n completa

---

### 5. **Backup LÃ³gico vs FÃ­sico**

| Tipo | DescripciÃ³n | Herramienta | Uso |
|------|-------------|-------------|-----|
| **LÃ³gico** | Exporta datos como SQL/JSON | `pg_dump`, scripts custom | Portabilidad, migraciÃ³n |
| **FÃ­sico** | Copia archivos de BD raw | Supabase snapshots | RecuperaciÃ³n rÃ¡pida |

**Estrategia EBS:** Usamos **AMBOS**
- LÃ³gico: Backup diario personalizado (portabilidad)
- FÃ­sico: Supabase snapshots (velocidad)

---

## â° FRECUENCIA Y RETENCIÃ“N

### Calendario de Respaldos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CALENDARIO SEMANAL                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  LUNES - VIERNES:                                    â”‚
â”‚    02:00 AM  â†’ Backup COMPLETO diario               â”‚
â”‚    08:00 AM  â†’ Backup INCREMENTAL                   â”‚
â”‚    02:00 PM  â†’ Backup INCREMENTAL                   â”‚
â”‚    08:00 PM  â†’ Backup INCREMENTAL                   â”‚
â”‚                                                       â”‚
â”‚  SÃBADO:                                             â”‚
â”‚    02:00 AM  â†’ Backup COMPLETO diario               â”‚
â”‚    No incrementales (bajo trÃ¡fico)                   â”‚
â”‚                                                       â”‚
â”‚  DOMINGO:                                            â”‚
â”‚    03:00 AM  â†’ Backup COMPLETO + OFFSITE            â”‚
â”‚    SincronizaciÃ³n a AWS S3                          â”‚
â”‚    VerificaciÃ³n de integridad                        â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### PolÃ­tica de RetenciÃ³n

#### Datos CrÃ­ticos (Facturas, Transacciones)

| Tipo Backup | Frecuencia | RetenciÃ³n | UbicaciÃ³n |
|-------------|------------|-----------|-----------|
| Supabase PITR | Continuo | 7 dÃ­as | Supabase cloud |
| Completo diario | 1x/dÃ­a | 30 dÃ­as | Supabase storage |
| Completo semanal | 1x/semana | 90 dÃ­as | AWS S3 |
| Completo mensual | 1x/mes | 1 aÃ±o | AWS S3 Glacier |
| Backup anual | 1x/aÃ±o | 3 aÃ±os | AWS S3 Deep Archive |

#### Datos Importantes (Productos, Clientes)

| Tipo Backup | Frecuencia | RetenciÃ³n | UbicaciÃ³n |
|-------------|------------|-----------|-----------|
| Completo diario | 1x/dÃ­a | 30 dÃ­as | Supabase storage |
| Completo semanal | 1x/semana | 90 dÃ­as | AWS S3 |
| Completo mensual | 1x/mes | 6 meses | AWS S3 |

#### Datos Normales (ConfiguraciÃ³n, Logs)

| Tipo Backup | Frecuencia | RetenciÃ³n | UbicaciÃ³n |
|-------------|------------|-----------|-----------|
| Completo diario | 1x/dÃ­a | 7 dÃ­as | Supabase storage |
| Completo semanal | 1x/semana | 30 dÃ­as | AWS S3 |

### CÃ¡lculo de Espacio Requerido

**EstimaciÃ³n basada en volumen actual:**

```
Base de datos actual: ~50 MB
Crecimiento estimado: +10 MB/mes

AÃ‘O 1:
â”œâ”€ Diarios (30 dÃ­as Ã— 50 MB): 1.5 GB
â”œâ”€ Semanales (12 Ã— 60 MB): 720 MB
â”œâ”€ Mensuales (12 Ã— 60 MB): 720 MB
â””â”€ TOTAL: ~3 GB

Costo estimado AWS S3: $0.023/GB/mes = ~$0.07/mes
```

---

## ğŸ”§ PROCEDIMIENTOS DE RESPALDO

### Procedimiento 1: Backup Completo AutomÃ¡tico Diario

**Frecuencia:** Diario a las 2:00 AM  
**DuraciÃ³n estimada:** 5-10 minutos  
**Responsable:** Sistema (cron job)

**Script automatizado:**

```bash
#!/bin/bash
# Script: backup_diario_ebs.sh
# UbicaciÃ³n: /opt/ebs/scripts/backup_diario_ebs.sh

# Variables de configuraciÃ³n
FECHA=$(date +%Y-%m-%d_%H-%M-%S)
BACKUP_DIR="/var/backups/ebs"
LOG_FILE="/var/log/ebs_backup.log"
SUPABASE_URL="https://jqkfykverasqwlfsjsnj.supabase.co"
SUPABASE_KEY="[ANON_KEY]"
S3_BUCKET="s3://ebs-backups-prod"

# FunciÃ³n de log
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

log "=== INICIO BACKUP COMPLETO DIARIO ==="

# 1. Crear directorio de backup del dÃ­a
mkdir -p "${BACKUP_DIR}/${FECHA}"
cd "${BACKUP_DIR}/${FECHA}"

# 2. Backup de cada tabla en formato JSON
log "Exportando tablas..."

# Productos
curl -X GET "${SUPABASE_URL}/rest/v1/productos?select=*" \
  -H "apikey: ${SUPABASE_KEY}" \
  -H "Authorization: Bearer ${SUPABASE_KEY}" \
  > productos.json
log "âœ“ Productos exportados: $(wc -l < productos.json) registros"

# Clientes
curl -X GET "${SUPABASE_URL}/rest/v1/clientes?select=*" \
  -H "apikey: ${SUPABASE_KEY}" \
  -H "Authorization: Bearer ${SUPABASE_KEY}" \
  > clientes.json
log "âœ“ Clientes exportados"

# Facturas
curl -X GET "${SUPABASE_URL}/rest/v1/facturas?select=*" \
  -H "apikey: ${SUPABASE_KEY}" \
  -H "Authorization: Bearer ${SUPABASE_KEY}" \
  > facturas.json
log "âœ“ Facturas exportadas"

# Abonos
curl -X GET "${SUPABASE_URL}/rest/v1/abonos?select=*" \
  -H "apikey: ${SUPABASE_KEY}" \
  -H "Authorization: Bearer ${SUPABASE_KEY}" \
  > abonos.json
log "âœ“ Abonos exportados"

# Movimientos inventario
curl -X GET "${SUPABASE_URL}/rest/v1/movimientos_inventario?select=*" \
  -H "apikey: ${SUPABASE_KEY}" \
  -H "Authorization: Bearer ${SUPABASE_KEY}" \
  > movimientos_inventario.json
log "âœ“ Movimientos de inventario exportados"

# 3. Crear archivo de metadatos
cat > metadata.json <<EOF
{
  "fecha_backup": "${FECHA}",
  "tipo": "completo_diario",
  "version_sistema": "1.0",
  "tablas": ["productos", "clientes", "facturas", "abonos", "movimientos_inventario"],
  "servidor": "$(hostname)",
  "usuario": "$(whoami)"
}
EOF

# 4. Comprimir backup
log "Comprimiendo backup..."
tar -czf "backup_${FECHA}.tar.gz" *.json metadata.json
BACKUP_SIZE=$(du -h "backup_${FECHA}.tar.gz" | cut -f1)
log "âœ“ Backup comprimido: ${BACKUP_SIZE}"

# 5. Verificar integridad (checksum)
sha256sum "backup_${FECHA}.tar.gz" > "backup_${FECHA}.sha256"
log "âœ“ Checksum generado"

# 6. Limpiar archivos temporales
rm -f *.json

# 7. Eliminar backups antiguos (>30 dÃ­as)
log "Limpiando backups antiguos..."
find ${BACKUP_DIR} -name "backup_*.tar.gz" -mtime +30 -delete
log "âœ“ Backups antiguos eliminados"

# 8. Registrar en base de datos
log "Registrando backup en sistema..."
# [AquÃ­ irÃ­a el registro en tabla control_backups]

# 9. NotificaciÃ³n de Ã©xito
log "=== BACKUP COMPLETADO EXITOSAMENTE ==="
log "TamaÃ±o: ${BACKUP_SIZE}"
log "UbicaciÃ³n: ${BACKUP_DIR}/${FECHA}/backup_${FECHA}.tar.gz"

# Opcional: Enviar notificaciÃ³n por email/webhook
# curl -X POST https://hooks.slack.com/... -d "Backup diario completado"

exit 0
```

**ConfiguraciÃ³n del cron:**
```bash
# Editar crontab
crontab -e

# Agregar lÃ­nea para ejecutar a las 2 AM diario
0 2 * * * /opt/ebs/scripts/backup_diario_ebs.sh >> /var/log/ebs_backup.log 2>&1
```

---

### Procedimiento 2: Backup Incremental

**Frecuencia:** Cada 6 horas (8 AM, 2 PM, 8 PM)  
**DuraciÃ³n estimada:** 1-2 minutos

**Script:**
```bash
#!/bin/bash
# Script: backup_incremental_ebs.sh

FECHA=$(date +%Y-%m-%d_%H-%M-%S)
BACKUP_DIR="/var/backups/ebs/incremental"
ULTIMO_BACKUP=$(cat /var/backups/ebs/.last_backup_time)

log "=== INICIO BACKUP INCREMENTAL ==="
log "Desde: ${ULTIMO_BACKUP}"

# Solo registros modificados desde Ãºltimo backup
curl -X GET "${SUPABASE_URL}/rest/v1/facturas?created_at=gte.${ULTIMO_BACKUP}&select=*" \
  -H "apikey: ${SUPABASE_KEY}" \
  > "${BACKUP_DIR}/facturas_inc_${FECHA}.json"

# Actualizar timestamp del Ãºltimo backup
date -Iseconds > /var/backups/ebs/.last_backup_time

log "=== BACKUP INCREMENTAL COMPLETADO ==="
```

---

### Procedimiento 3: Backup Off-Site Semanal

**Frecuencia:** Domingos 3:00 AM  
**DuraciÃ³n estimada:** 15-20 minutos  
**Destino:** AWS S3 (regiÃ³n us-west-2)

**Script:**
```bash
#!/bin/bash
# Script: backup_offsite_semanal.sh

FECHA=$(date +%Y-%m-%d)
BACKUP_LOCAL="/var/backups/ebs"
S3_BUCKET="s3://ebs-backups-prod"
S3_PATH="${S3_BUCKET}/weekly/${FECHA}"

log "=== INICIO BACKUP OFF-SITE SEMANAL ==="

# 1. Ejecutar backup completo primero
/opt/ebs/scripts/backup_diario_ebs.sh

# 2. Sincronizar a S3
log "Sincronizando con AWS S3..."
aws s3 sync ${BACKUP_LOCAL} ${S3_PATH} \
  --storage-class STANDARD_IA \
  --exclude "incremental/*" \
  --exclude "*.log"

# 3. Verificar sincronizaciÃ³n
S3_COUNT=$(aws s3 ls ${S3_PATH} --recursive | wc -l)
log "âœ“ ${S3_COUNT} archivos sincronizados a S3"

# 4. Prueba de recuperaciÃ³n (descargar y verificar checksum)
log "Verificando integridad en S3..."
ULTIMO_BACKUP=$(ls -t ${BACKUP_LOCAL}/*/backup_*.tar.gz | head -1)
CHECKSUM_LOCAL=$(sha256sum ${ULTIMO_BACKUP} | cut -d' ' -f1)

aws s3 cp ${S3_PATH}/$(basename ${ULTIMO_BACKUP}).sha256 /tmp/
CHECKSUM_S3=$(cat /tmp/$(basename ${ULTIMO_BACKUP}).sha256 | cut -d' ' -f1)

if [ "${CHECKSUM_LOCAL}" == "${CHECKSUM_S3}" ]; then
    log "âœ“ Integridad verificada correctamente"
else
    log "âœ— ERROR: Checksums no coinciden"
    # Enviar alerta crÃ­tica
    exit 1
fi

# 5. Configurar lifecycle policy para mover a Glacier despuÃ©s de 90 dÃ­as
aws s3api put-bucket-lifecycle-configuration \
  --bucket ebs-backups-prod \
  --lifecycle-configuration file:///opt/ebs/config/s3_lifecycle.json

log "=== BACKUP OFF-SITE COMPLETADO ==="
```

---

### Procedimiento 4: Backup Manual Pre-Cambios

**CuÃ¡ndo ejecutar:**
- Antes de actualizaciones del sistema
- Antes de migraciones de datos
- Antes de cambios masivos en catÃ¡logo
- Antes de modificaciones en estructura de BD

**Pasos manuales:**

1. **Notificar a usuarios:**
   ```
   "Se realizarÃ¡ mantenimiento programado.
   Sistema no disponible: [hora inicio] - [hora fin]
   DuraciÃ³n estimada: 30 minutos"
   ```

2. **Poner sistema en modo mantenimiento:**
   ```bash
   touch /var/www/ebs/.maintenance
   ```

3. **Ejecutar backup completo:**
   ```bash
   /opt/ebs/scripts/backup_diario_ebs.sh manual
   ```

4. **Etiquetar backup:**
   ```bash
   mv backup_[fecha].tar.gz backup_PRE_ACTUALIZACION_[fecha].tar.gz
   ```

5. **Verificar integridad:**
   ```bash
   sha256sum -c backup_PRE_ACTUALIZACION_[fecha].sha256
   ```

6. **Copiar a ubicaciÃ³n segura adicional:**
   ```bash
   aws s3 cp backup_PRE_ACTUALIZACION_[fecha].tar.gz \
     s3://ebs-backups-prod/manual/
   ```

7. **Documentar en log:**
   ```bash
   echo "Backup manual pre-actualizaciÃ³n: [motivo]" >> /var/log/ebs_manual_backups.log
   ```

---

## ğŸ”„ PROCEDIMIENTOS DE RESTAURACIÃ“N

### Escenarios de RecuperaciÃ³n

#### Escenario 1: RecuperaciÃ³n de Factura Eliminada Accidentalmente

**RPO:** < 1 hora  
**RTO:** < 15 minutos  
**Complejidad:** Baja

**Pasos:**

1. **Identificar factura a recuperar:**
   ```sql
   -- Buscar en tabla de auditorÃ­a
   SELECT * FROM auditoria_facturas 
   WHERE factura_id = [ID] 
   ORDER BY fecha_eliminacion DESC LIMIT 1;
   ```

2. **Usar Point-in-Time Recovery de Supabase:**
   - Dashboard Supabase â†’ Database â†’ Backups
   - Seleccionar timestamp antes de eliminaciÃ³n
   - Clic en "Restore specific tables"
   - Seleccionar tabla `facturas`
   - Especificar ID de factura

3. **Verificar recuperaciÃ³n:**
   ```sql
   SELECT * FROM facturas WHERE id = [ID];
   ```

4. **Notificar al usuario:**
   ```
   "Factura #[ID] recuperada exitosamente.
   Datos restaurados al: [fecha/hora]"
   ```

**Tiempo estimado:** 10-15 minutos

---

#### Escenario 2: CorrupciÃ³n de Tabla de Productos

**RPO:** 4 horas (Ãºltimo incremental)  
**RTO:** 1 hora  
**Complejidad:** Media

**Pasos:**

1. **Confirmar corrupciÃ³n:**
   ```sql
   SELECT COUNT(*) FROM productos; -- Error o resultado incorrecto
   ```

2. **Poner tabla en modo solo lectura:**
   ```sql
   -- Crear polÃ­tica temporal
   CREATE POLICY "readonly" ON productos FOR ALL USING (false);
   ```

3. **Descargar Ãºltimo backup completo:**
   ```bash
   cd /tmp
   aws s3 cp s3://ebs-backups-prod/latest/backup_productos.json .
   ```

4. **Truncar tabla corrupta:**
   ```sql
   TRUNCATE TABLE productos CASCADE; -- Cuidado con dependencias
   ```

5. **Importar desde backup:**
   ```bash
   # Usando script de importaciÃ³n
   node /opt/ebs/scripts/import_productos.js backup_productos.json
   ```

6. **Verificar integridad:**
   ```sql
   SELECT COUNT(*) FROM productos; -- Debe coincidir con backup
   SELECT * FROM productos WHERE precio IS NULL; -- No debe haber
   ```

7. **Restaurar polÃ­ticas normales:**
   ```sql
   DROP POLICY "readonly" ON productos;
   ```

8. **Aplicar cambios incrementales (si los hay):**
   ```bash
   # Importar cambios desde Ãºltimo incremental
   node /opt/ebs/scripts/import_incremental.js
   ```

**Tiempo estimado:** 45-60 minutos

---

#### Escenario 3: PÃ©rdida Total de Base de Datos

**RPO:** 24 horas (peor caso)  
**RTO:** 4 horas  
**Complejidad:** Alta

**Pasos:**

1. **âš ï¸ ACTIVAR PLAN DE RECUPERACIÃ“N DE DESASTRES**

2. **Evaluar daÃ±o:**
   - Â¿Supabase disponible? â†’ Restaurar desde snapshot
   - Â¿Supabase caÃ­do? â†’ Restaurar desde backup off-site

3. **OpciÃ³n A: Restaurar desde Supabase Snapshot**
   ```
   Dashboard Supabase â†’ Database â†’ Backups
   â†’ Select latest snapshot
   â†’ Click "Restore"
   â†’ Confirm (takes 15-30 min)
   ```

4. **OpciÃ³n B: Restaurar desde AWS S3 (desastre total)**

   a. **Crear nueva instancia Supabase:**
      - Dashboard â†’ New Project
      - Region: us-east-1
      - Plan: Pro (mÃ­nimo)

   b. **Descargar Ãºltimo backup semanal:**
      ```bash
      aws s3 sync s3://ebs-backups-prod/weekly/latest /tmp/restore
      ```

   c. **Descomprimir:**
      ```bash
      cd /tmp/restore
      tar -xzf backup_*.tar.gz
      ```

   d. **Verificar integridad:**
      ```bash
      sha256sum -c backup_*.sha256
      ```

   e. **Crear estructura de tablas:**
      ```bash
      psql -h [NEW_SUPABASE_HOST] -U postgres -f /opt/ebs/schema/create_tables.sql
      ```

   f. **Importar datos:**
      ```bash
      node /opt/ebs/scripts/restore_full.js /tmp/restore
      ```

   g. **Verificar conteos:**
      ```sql
      SELECT 'productos' as tabla, COUNT(*) FROM productos
      UNION ALL
      SELECT 'clientes', COUNT(*) FROM clientes
      UNION ALL
      SELECT 'facturas', COUNT(*) FROM facturas;
      ```

   h. **Actualizar variables de entorno en aplicaciÃ³n:**
      ```bash
      export VITE_SUPABASE_URL="https://[NEW_PROJECT].supabase.co"
      export VITE_SUPABASE_ANON_KEY="[NEW_ANON_KEY]"
      ```

   i. **Aplicar incrementales (si existen):**
      ```bash
      # Restaurar cambios desde Ãºltimo semanal
      for file in /tmp/restore/incremental/*.json; do
        node /opt/ebs/scripts/import_incremental.js $file
      done
      ```

   j. **Pruebas de humo:**
      - [ ] Login funciona
      - [ ] Crear factura de prueba
      - [ ] Consultar productos
      - [ ] Ver reportes

   k. **Activar aplicaciÃ³n:**
      ```bash
      rm /var/www/ebs/.maintenance
      systemctl restart ebs-app
      ```

5. **ComunicaciÃ³n a usuarios:**
   ```
   "Sistema restaurado desde backup.
   Ãšltima actualizaciÃ³n: [fecha/hora del backup]
   Posible pÃ©rdida de datos: [X horas]
   Favor verificar operaciones recientes."
   ```

**Tiempo estimado:** 3-4 horas

---

#### Escenario 4: Rollback por ActualizaciÃ³n Fallida

**RTO:** 30 minutos  
**Complejidad:** Baja

**Pasos:**

1. **Usar backup pre-actualizaciÃ³n:**
   ```bash
   cd /var/backups/ebs
   ls -lt backup_PRE_ACTUALIZACION_*.tar.gz | head -1
   ```

2. **Restaurar cÃ³digo anterior:**
   ```bash
   cd /var/www/ebs
   git reset --hard [COMMIT_ANTERIOR]
   npm install
   npm run build
   ```

3. **Restaurar base de datos:**
   ```bash
   tar -xzf backup_PRE_ACTUALIZACION_*.tar.gz
   node /opt/ebs/scripts/restore_full.js .
   ```

4. **Reiniciar servicios:**
   ```bash
   systemctl restart ebs-app
   systemctl restart nginx
   ```

5. **Verificar funcionamiento:**
   - [ ] Login
   - [ ] Operaciones crÃ­ticas

**Tiempo estimado:** 20-30 minutos

---

## ğŸš¨ PLAN DE RECUPERACIÃ“N ANTE DESASTRES (DRP)

### DefiniciÃ³n de Desastre

**Desastre = evento que causa la indisponibilidad total del sistema por >2 horas**

**Causas potenciales:**
- ğŸ”¥ CaÃ­da total de Supabase
- ğŸ’¥ CorrupciÃ³n masiva de datos
- ğŸ”“ Ataque de ransomware
- ğŸŒªï¸ Desastre natural afectando datacenter
- ğŸ‘¤ EliminaciÃ³n accidental masiva de datos

### Protocolo de ActivaciÃ³n DRP

#### Fase 1: DETECCIÃ“N Y EVALUACIÃ“N (0-15 min)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CHECKLIST DE EVALUACIÃ“N                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ ] Â¿Supabase responde?                   â”‚
â”‚  [ ] Â¿Base de datos accesible?             â”‚
â”‚  [ ] Â¿Datos visiblemente corruptos?        â”‚
â”‚  [ ] Â¿AplicaciÃ³n funcional?                â”‚
â”‚  [ ] Â¿Backups disponibles?                 â”‚
â”‚  [ ] Â¿Tiempo de caÃ­da estimado?            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SI 2+ RESPUESTAS NEGATIVAS â†’ ACTIVAR DRP
```

**Responsable:** Edwin MarÃ­n (on-call)

---

#### Fase 2: ACTIVACIÃ“N Y COMUNICACIÃ“N (15-30 min)

**Acciones inmediatas:**

1. **Declarar estado de desastre:**
   ```bash
   echo "DESASTRE DECLARADO: $(date)" > /var/log/disaster_recovery.log
   ```

2. **Notificar stakeholders:**
   ```
   ğŸ“§ Email a: cliente@empresa.com
   ğŸ“± WhatsApp a: [Gerente]
   
   Asunto: [CRÃTICO] Sistema EBS - RecuperaciÃ³n de Desastre
   
   Estimado cliente:
   
   Se ha detectado una falla crÃ­tica en el Sistema EBS.
   Hemos activado el Plan de RecuperaciÃ³n ante Desastres.
   
   SituaciÃ³n: [descripciÃ³n breve]
   Tiempo estimado de recuperaciÃ³n: [X horas]
   Ãšltima copia de seguridad disponible: [fecha/hora]
   
   PrÃ³xima actualizaciÃ³n en: 1 hora
   
   Contacto de emergencia: +57 XXX XXX XXXX
   ```

3. **Formar equipo de recuperaciÃ³n:**
   - LÃ­der tÃ©cnico: Edwin MarÃ­n
   - Soporte: [Nombre si disponible]
   - Contacto cliente: [Usuario clave]

---

#### Fase 3: RECUPERACIÃ“N (30 min - 4 horas)

**Seguir procedimiento "Escenario 3: PÃ©rdida Total de Base de Datos"**

**Puntos de control cada hora:**
- âœ… Hora 1: Infraestructura nueva levantada
- âœ… Hora 2: Datos restaurados y verificados
- âœ… Hora 3: AplicaciÃ³n funcional en ambiente de prueba
- âœ… Hora 4: Sistema en producciÃ³n con usuarios

---

#### Fase 4: VALIDACIÃ“N (4-6 horas)

**Checklist de validaciÃ³n:**

```sql
-- 1. Verificar conteo de registros
SELECT 
  (SELECT COUNT(*) FROM productos) as productos,
  (SELECT COUNT(*) FROM clientes) as clientes,
  (SELECT COUNT(*) FROM facturas) as facturas,
  (SELECT COUNT(*) FROM abonos) as abonos;
-- Comparar con snapshot previo

-- 2. Verificar Ãºltima factura
SELECT * FROM facturas ORDER BY created_at DESC LIMIT 1;
-- Confirmar con cliente si es la Ãºltima conocida

-- 3. Verificar stocks
SELECT nombre, stock FROM productos WHERE stock < 0;
-- No debe haber stocks negativos

-- 4. Verificar integridad referencial
SELECT f.id, f.cliente 
FROM facturas f
LEFT JOIN clientes c ON f.cliente = c.nombre
WHERE c.id IS NULL;
-- No debe haber huÃ©rfanos
```

**Pruebas funcionales:**
- [ ] Login de todos los usuarios
- [ ] Crear factura de prueba
- [ ] Registrar abono
- [ ] Consultar reportes
- [ ] Exportar datos

---

#### Fase 5: POST-MORTEM (1 semana despuÃ©s)

**ReuniÃ³n obligatoria con:**
- Cliente (gerente + usuario clave)
- Edwin MarÃ­n (lÃ­der tÃ©cnico)

**Agenda:**
1. Â¿QuÃ© causÃ³ el desastre?
2. Â¿QuÃ© funcionÃ³ bien en la recuperaciÃ³n?
3. Â¿QuÃ© se puede mejorar?
4. Â¿PÃ©rdidas de datos confirmadas?
5. Â¿Acciones correctivas?

**Documento:** `Post_Mortem_Desastre_[FECHA].md`

---

### Tiempos de RecuperaciÃ³n por Escenario

| Escenario | RTO | RPO | Probabilidad | Impacto |
|-----------|-----|-----|--------------|---------|
| Factura eliminada | 15 min | 1 hora | ğŸŸ¢ Alta | ğŸŸ¢ Bajo |
| Tabla corrupta | 1 hora | 4 horas | ğŸŸ¡ Media | ğŸŸ¡ Medio |
| BD completa perdida | 4 horas | 24 horas | ğŸ”´ Baja | ğŸ”´ Alto |
| CaÃ­da de Supabase | 30 min | 1 hora | ğŸŸ¢ Media | ğŸŸ¡ Medio |
| Ransomware | 8 horas | 48 horas | ğŸŸ¢ Muy baja | ğŸ”´ CrÃ­tico |

---

## ğŸ§ª PRUEBAS DE RECUPERACIÃ“N

### Frecuencia de Pruebas

| Tipo de Prueba | Frecuencia | Responsable | DuraciÃ³n |
|----------------|------------|-------------|----------|
| **RestauraciÃ³n de archivo Ãºnico** | Mensual | Edwin MarÃ­n | 30 min |
| **RestauraciÃ³n de tabla completa** | Trimestral | Edwin MarÃ­n | 2 horas |
| **Simulacro de desastre completo** | Semestral | Edwin + Cliente | 4 horas |
| **VerificaciÃ³n de integridad** | Semanal | AutomÃ¡tico | 10 min |

### Procedimiento de Prueba Mensual

**Objetivo:** Verificar que los backups son recuperables.

**Pasos:**

1. **Seleccionar backup aleatorio del mes anterior:**
   ```bash
   BACKUP=$(ls -1 /var/backups/ebs/*/backup_*.tar.gz | shuf -n 1)
   echo "Probando: $BACKUP"
   ```

2. **Crear ambiente de prueba:**
   ```bash
   mkdir -p /tmp/test_restore
   cd /tmp/test_restore
   ```

3. **Descomprimir:**
   ```bash
   tar -xzf $BACKUP
   ```

4. **Verificar checksum:**
   ```bash
   sha256sum -c *.sha256
   ```

5. **Importar a BD de prueba:**
   ```bash
   node /opt/ebs/scripts/restore_to_test_db.js .
   ```

6. **Consultas de verificaciÃ³n:**
   ```sql
   SELECT COUNT(*) FROM test_productos;
   SELECT COUNT(*) FROM test_facturas;
   ```

7. **Documentar resultado:**
   ```bash
   cat >> /var/log/pruebas_restauracion.log <<EOF
   [$(date)]
   Backup probado: $BACKUP
   Resultado: EXITOSO
   Productos: [count]
   Facturas: [count]
   Tiempo: [X] minutos
   EOF
   ```

8. **Limpiar:**
   ```bash
   rm -rf /tmp/test_restore
   DROP DATABASE test_ebs;
   ```

**Criterio de Ã©xito:** 100% de datos recuperables y verificables.

---

### Simulacro de Desastre Semestral

**Objetivo:** Entrenar al equipo y validar el DRP completo.

**Fecha:** Primer domingo de enero y julio  
**DuraciÃ³n:** 4 horas (9 AM - 1 PM)  
**Participantes:** Edwin + Usuario clave del cliente

**Escenario simulado:**
```
"Ha ocurrido una falla catastrÃ³fica. 
La base de datos Supabase estÃ¡ completamente inaccesible.
Deben recuperar el sistema desde cero usando solo backups off-site."
```

**Checklist del simulacro:**

```
HORA 00:00 - INICIO
â”œâ”€ [ ] Declarar simulacro de desastre
â”œâ”€ [ ] Notificar (simulado) a stakeholders
â””â”€ [ ] Documentar timestamp de inicio

HORA 00:15 - EVALUACIÃ“N
â”œâ”€ [ ] Listar backups disponibles
â”œâ”€ [ ] Elegir backup mÃ¡s reciente
â””â”€ [ ] Descargar desde S3

HORA 00:30 - PREPARACIÃ“N
â”œâ”€ [ ] Crear nueva instancia Supabase (ambiente staging)
â”œâ”€ [ ] Configurar variables de entorno
â””â”€ [ ] Crear estructura de tablas

HORA 01:00 - RESTAURACIÃ“N
â”œâ”€ [ ] Importar datos desde backup
â”œâ”€ [ ] Verificar checksums
â””â”€ [ ] Aplicar incrementales

HORA 02:00 - VALIDACIÃ“N
â”œâ”€ [ ] Ejecutar queries de verificaciÃ³n
â”œâ”€ [ ] Pruebas funcionales
â””â”€ [ ] Comparar con snapshot conocido

HORA 03:00 - ACTIVACIÃ“N
â”œâ”€ [ ] Levantar aplicaciÃ³n
â”œâ”€ [ ] Pruebas de usuario final
â””â”€ [ ] Declarar sistema operativo

HORA 04:00 - CIERRE
â”œâ”€ [ ] Documentar lecciones aprendidas
â”œâ”€ [ ] Identificar mejoras al DRP
â””â”€ [ ] Destruir ambiente de simulacro
```

**Reporte post-simulacro:**
- Â¿Se cumpliÃ³ el RTO de 4 horas?
- Â¿Hubo problemas inesperados?
- Â¿El equipo siguiÃ³ el procedimiento?
- Â¿Mejoras necesarias al DRP?

---

## ğŸ“Š MONITOREO Y ALERTAS

### Sistema de Monitoreo

**Herramientas:**
- Supabase Dashboard (built-in monitoring)
- AWS CloudWatch (para backups en S3)
- Cron logs (para scripts de backup)
- Script custom de verificaciÃ³n

### Alertas CrÃ­ticas

| Evento | Severidad | AcciÃ³n | Destinatario |
|--------|-----------|--------|--------------|
| Backup diario fallÃ³ | ğŸ”´ CRÃTICA | Investigar inmediatamente | Edwin (WhatsApp + Email) |
| Backup tardÃ³ >30 min | ğŸŸ¡ ALTA | Revisar en 2 horas | Edwin (Email) |
| Backup off-site fallÃ³ | ğŸ”´ CRÃTICA | Reintentar + investigar | Edwin (WhatsApp) |
| VerificaciÃ³n integridad fallÃ³ | ğŸ”´ CRÃTICA | Re-generar backup | Edwin (WhatsApp) |
| Espacio disco <10% | ğŸŸ¡ ALTA | Limpiar backups viejos | Edwin (Email) |
| S3 bucket inaccesible | ğŸ”´ CRÃTICA | Revisar credenciales AWS | Edwin (WhatsApp) |

### Script de Monitoreo AutomÃ¡tico

```bash
#!/bin/bash
# Script: monitor_backups.sh
# Ejecuta cada hora para verificar estado de backups

ULTIMO_BACKUP=$(ls -t /var/backups/ebs/*/backup_*.tar.gz | head -1)
EDAD_BACKUP=$(( ($(date +%s) - $(stat -f %m "$ULTIMO_BACKUP")) / 3600 ))

# Alerta si backup mÃ¡s reciente tiene >25 horas
if [ $EDAD_BACKUP -gt 25 ]; then
    echo "ğŸš¨ ALERTA: Ãšltimo backup tiene $EDAD_BACKUP horas de antigÃ¼edad"
    # Enviar webhook a Slack/Email
    curl -X POST https://hooks.slack.com/services/XXX/YYY/ZZZ \
      -d "{\"text\": \"âš ï¸ Backup EBS retrasado: ${EDAD_BACKUP} horas\"}"
fi

# Verificar tamaÃ±o del backup (debe ser >1MB)
TAMANIO=$(stat -f %z "$ULTIMO_BACKUP")
if [ $TAMANIO -lt 1048576 ]; then
    echo "ğŸš¨ ALERTA: Backup sospechosamente pequeÃ±o: $(($TAMANIO / 1024))KB"
fi

# Verificar espacio en disco
ESPACIO_LIBRE=$(df -h /var/backups | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $ESPACIO_LIBRE -gt 90 ]; then
    echo "âš ï¸ ADVERTENCIA: Disco casi lleno: ${ESPACIO_LIBRE}%"
fi

# Verificar conectividad con S3
aws s3 ls s3://ebs-backups-prod/ > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "ğŸš¨ ALERTA: No se puede acceder a S3"
fi

echo "âœ“ Monitoreo completado: $(date)"
```

**Configurar en cron cada hora:**
```bash
0 * * * * /opt/ebs/scripts/monitor_backups.sh >> /var/log/monitor_backups.log 2>&1
```

---

### Dashboard de Estado de Backups

**InformaciÃ³n visible:**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ESTADO DE BACKUPS - SISTEMA EBS           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Ãšltimo backup completo:                      â•‘
â•‘   ğŸ“… Fecha: 2026-02-03 02:00:15             â•‘
â•‘   ğŸ’¾ TamaÃ±o: 52.3 MB                        â•‘
â•‘   âœ… Estado: EXITOSO                        â•‘
â•‘   ğŸ” Checksum: Verificado                   â•‘
â•‘                                              â•‘
â•‘ Ãšltimo backup incremental:                   â•‘
â•‘   ğŸ“… Fecha: 2026-02-03 14:00:05             â•‘
â•‘   ğŸ’¾ TamaÃ±o: 2.1 MB                         â•‘
â•‘   âœ… Estado: EXITOSO                        â•‘
â•‘                                              â•‘
â•‘ Ãšltimo backup off-site:                      â•‘
â•‘   ğŸ“… Fecha: 2026-02-02 03:00:00             â•‘
â•‘   ğŸ’¾ TamaÃ±o: 51.8 MB                        â•‘
â•‘   âœ… Estado: SINCRONIZADO                   â•‘
â•‘   ğŸŒ UbicaciÃ³n: AWS S3 us-west-2            â•‘
â•‘                                              â•‘
â•‘ Almacenamiento:                              â•‘
â•‘   ğŸ“Š Local: 3.2 GB / 100 GB (3.2%)          â•‘
â•‘   â˜ï¸  S3: 12.1 GB / 1 TB (1.2%)             â•‘
â•‘                                              â•‘
â•‘ PrÃ³ximos backups:                            â•‘
â•‘   â° Incremental: Hoy 20:00                 â•‘
â•‘   â° Completo: MaÃ±ana 02:00                 â•‘
â•‘   â° Off-site: Domingo 03:00                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ‘¥ ROLES Y RESPONSABILIDADES

### Matriz RACI

| Actividad | Edwin MarÃ­n | Cliente | Supabase | AWS |
|-----------|-------------|---------|----------|-----|
| **Backup automÃ¡tico diario** | R, A | I | C | - |
| **Backup off-site semanal** | R, A | I | - | C |
| **VerificaciÃ³n de backups** | R, A | I | - | - |
| **Pruebas de restauraciÃ³n** | R, A | C | I | - |
| **Monitoreo de alertas** | R, A | I | I | I |
| **RecuperaciÃ³n ante desastre** | R, A | C | C | C |
| **Simulacros semestrales** | R | A | - | - |
| **AuditorÃ­as de backups** | R | A, I | - | - |

**Leyenda:**
- **R** (Responsible): Ejecuta la tarea
- **A** (Accountable): Aprueba y es responsable final
- **C** (Consulted): Debe ser consultado
- **I** (Informed): Debe ser informado

### Contactos de Emergencia

| Rol | Nombre | TelÃ©fono | Email | Disponibilidad |
|-----|--------|----------|-------|----------------|
| **LÃ­der TÃ©cnico** | Edwin MarÃ­n | +57 XXX XXX XXXX | edwin@ebs.com | 24/7 |
| **Contacto Cliente** | [Nombre] | +57 XXX XXX XXXX | cliente@empresa.com | Lun-SÃ¡b 8-20h |
| **Soporte Supabase** | - | - | support@supabase.io | 24/7 (Plan Pro) |
| **Soporte AWS** | - | - | Via Console | 24/7 (Plan Business) |

---

## ğŸ’° COSTOS Y RECURSOS

### Costos de Almacenamiento

**Backup Local (Supabase):**
```
Incluido en plan Pro de Supabase: $25/mes
- Backups automÃ¡ticos: Ilimitados
- RetenciÃ³n PITR: 7 dÃ­as
- Snapshots: Ilimitados
```

**Backup Off-Site (AWS S3):**
```
Almacenamiento:
â”œâ”€ EstÃ¡ndar (primeros 30 dÃ­as): 3 GB Ã— $0.023/GB = $0.07/mes
â”œâ”€ Standard-IA (30-90 dÃ­as): 9 GB Ã— $0.0125/GB = $0.11/mes
â””â”€ Glacier (>90 dÃ­as): 40 GB Ã— $0.004/GB = $0.16/mes

Transferencia datos:
â””â”€ Semanal (52 Ã— 50MB): 2.6 GB Ã— $0.09/GB = $0.23/mes

TOTAL AWS: ~$0.60/mes
```

**Costo Total de Respaldos:**
```
Supabase Pro: $25.00/mes
AWS S3: $0.60/mes
Scripts/Mantenimiento: $0.00 (incluido)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL: $25.60/mes = $307/aÃ±o
```

### Recursos Computacionales

**Servidor de Backups:**
- CPU: < 5% durante backup
- RAM: 512 MB durante ejecuciÃ³n
- Disco: 100 GB recomendado (local)
- Red: 10 Mbps para sincronizaciÃ³n S3

**Ventana de Backup:**
- Backup diario: 2:00 - 2:10 AM (10 min)
- Backup incremental: 5 min por ejecuciÃ³n
- Backup off-site: 3:00 - 3:20 AM domingo (20 min)

---

## ğŸ“ DOCUMENTACIÃ“N Y AUDITORÃA

### Registro de Backups

**Tabla de control en base de datos:**

```sql
CREATE TABLE control_backups (
  id BIGSERIAL PRIMARY KEY,
  fecha_backup TIMESTAMP NOT NULL,
  tipo VARCHAR(50) NOT NULL, -- 'completo', 'incremental', 'offsite'
  tamanio_bytes BIGINT,
  ubicacion TEXT,
  checksum_sha256 VARCHAR(64),
  estado VARCHAR(20), -- 'exitoso', 'fallido', 'parcial'
  duracion_segundos INT,
  num_registros_respaldados INT,
  mensaje_error TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_backups_fecha ON control_backups(fecha_backup DESC);
CREATE INDEX idx_backups_tipo ON control_backups(tipo);
```

### Reporte Mensual de Backups

**Enviado automÃ¡ticamente primer dÃ­a de cada mes al cliente.**

**Contenido:**
```
REPORTE MENSUAL DE RESPALDOS
Sistema: EBS
PerÃ­odo: Enero 2026

RESUMEN:
âœ… Backups diarios ejecutados: 31/31 (100%)
âœ… Backups incrementales: 93/93 (100%)
âœ… Backups off-site: 4/4 (100%)
âœ… Pruebas de restauraciÃ³n: 1/1 (100%)

MÃ‰TRICAS:
- TamaÃ±o promedio backup: 52 MB
- Tiempo promedio backup: 8 minutos
- Espacio total usado: 3.4 GB local + 12.5 GB S3
- Tasa de crecimiento: +10% vs mes anterior

INCIDENCIAS:
- 03/01: Backup tardÃ³ 25 min (normal, carga alta)
- Ninguna falla crÃ­tica

PRÃ“XIMAS ACCIONES:
- Simulacro de desastre programado: 05/07/2026
```

---

## ğŸ“š REFERENCIAS Y DOCUMENTOS RELACIONADOS

### Documentos Internos
- [02.3_Plan_Migracion_Datos.md](./02.3_Plan_Migracion_Datos.md) - Plan de migraciÃ³n
- [03.2_Politica_Seguridad.md](../03_LEGAL/03.2_Politica_Seguridad.md) - PolÃ­ticas de seguridad
- [03.3_SLA_Soporte.md](../03_LEGAL/03.3_SLA_Soporte.md) - Acuerdos de nivel de servicio

### EstÃ¡ndares y Mejores PrÃ¡cticas
- ISO/IEC 27001:2013 - GestiÃ³n de Seguridad de la InformaciÃ³n
- NIST SP 800-34 - Contingency Planning Guide for Federal Information Systems
- CIS Controls v8 - Control 11: Data Recovery Capabilities

### Recursos Externos
- [Supabase Backup Documentation](https://supabase.com/docs/guides/database/backups)
- [AWS S3 Backup Best Practices](https://docs.aws.amazon.com/AmazonS3/latest/userguide/backup-and-restore-practices.html)
- [PostgreSQL Backup and Restore](https://www.postgresql.org/docs/current/backup.html)

---

## âœ… LISTA DE VERIFICACIÃ“N MENSUAL

**Responsable:** Edwin MarÃ­n  
**Frecuencia:** Primera semana de cada mes

```
[ ] Verificar que todos los backups diarios se ejecutaron
[ ] Revisar logs de errores en backups
[ ] Ejecutar prueba de restauraciÃ³n aleatoria
[ ] Verificar espacio disponible en almacenamiento
[ ] Confirmar backups off-site en S3
[ ] Revisar y actualizar lista de contactos de emergencia
[ ] Verificar vigencia de credenciales AWS
[ ] Ejecutar script de verificaciÃ³n de integridad
[ ] Generar y enviar reporte mensual al cliente
[ ] Documentar incidencias y lecciones aprendidas
```

---

## ğŸ“ SOPORTE Y CONTACTO

**Para consultas sobre este plan:**
- **Email:** soporte@distribucionesebs.com
- **WhatsApp:** +57 XXX XXX XXXX
- **Horario:** Lunes a Viernes 8 AM - 6 PM

**Para emergencias de recuperaciÃ³n (24/7):**
- **Edwin MarÃ­n:** +57 XXX XXX XXXX

---

## âœï¸ CONTROL DE VERSIONES

| VersiÃ³n | Fecha | Autor | Cambios |
|---------|-------|-------|---------|
| 1.0 | 2026-02-03 | Edwin MarÃ­n | CreaciÃ³n inicial del plan |
| | | | |

---

## âœï¸ APROBACIONES

| Rol | Nombre | Firma | Fecha |
|-----|--------|-------|-------|
| **Responsable TÃ©cnico** | Edwin MarÃ­n | __________ | ___/___/___ |
| **Cliente** | [Nombre] | __________ | ___/___/___ |
| **Gerente General** | [Nombre] | __________ | ___/___/___ |

---

**Fin del Plan de Respaldo y RecuperaciÃ³n de Datos**  
**VersiÃ³n:** 1.0  
**Ãšltima actualizaciÃ³n:** 3 de febrero de 2026

---

## ğŸ”„ PRÃ“XIMA REVISIÃ“N

Este plan debe ser revisado y actualizado:
- **Frecuencia regular:** Cada 6 meses
- **PrÃ³xima revisiÃ³n:** 3 de agosto de 2026
- **DespuÃ©s de cada desastre real:** Inmediatamente
- **DespuÃ©s de cada simulacro:** En 1 semana
- **Ante cambios en infraestructura:** Inmediatamente
